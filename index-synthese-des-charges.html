<meta charset="utf-8" />
<link rel="icon" type="image/png" href="assets/img/favicon.svg" />
<link rel="stylesheet" href="assets/css/style.css" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.9/summernote.css" rel="stylesheet" />
<div class="form synthese-des-charges">
  <div class="change-style-li"></div>
  <div class="col-md-6">
    <!-- AG -->

    <input type="text" name="nameRealEstate" id="title" class="latLong margin-top-10 realTime"
      placeholder="Nom du bien" />


    <p><strong>2/ SYNTHÈSE DES CHARGES</strong></p>
    <select class="type-mensuelle margin-top-10">
      <option value="">Type de synthèse des charges</option>
      <option value="Annuel">Annuel</option>
      <option value="Trimestriel">Trimestriel</option>
    </select>
    <br />

    <div id="block-type-charge" class="margin-top-10"></div>

    <input type="text" name="descriptionCharge" placeholder="Ce tableau des charges comprend" id="descriptionCharge"
      class="latLong margin-top-10" />
    <br />
    <!-- <input type="color" name="colorMensuelleTitle" class="change-color-mensuelle-title"
            placeholder="Couleur du moyenne mensuelle" />
        <input type="color" name="colorMensuelleContent" class="change-color-mensuelle-content"
            placeholder="Couleur du moyenne mensuelle" /> -->
    <br />
    <input type="text" name="valeurMensuelle" id="valeurMensuelle" class="latLong margin-top-10"
      placeholder="Valeur de la moyenne mensuelle" />
    <br />
    <!-- <input type="color" name="colorQuotites" class="change-color-quotites" placeholder="Couleur du quotites" />
        <br /> -->
    <input type="text" name="valeurQuotites" id="valeurQuotites" class="latLong margin-top-10"
      placeholder="Valeur de la quotités" />
    <p class="margin-top-10">
      <span class="validate-mensuelle cursor-pointer">Valider cette partie</span>
    </p>

    <!-- CHARTS -->
    <p>&nbsp;</p>
    <p><strong>3/ CAMEMBERT</strong></p>
    <input type="text" name="descriptionCamembert" class="latLong" placeholder="Nom de l'ACP" />
    <br />
    <div class="content-camembert-block"></div>
    <p class="margin-top-10">
      <span class="add-new-camembert cursor-pointer">+ Nouvelle ligne</span>
      <span class="validate-camembert cursor-pointer">Valider cette partie</span>
      <span class="reset-camembert cursor-pointer">Réinitialiser</span>
    </p>
    <p>&nbsp;</p>
  </div>
  <div class="col-md-6">
    <button onclick="$.MultiLanguage('language.json', 'fr')" id="lang-fr" class="changeLanguage btn btn-danger">
      FR
    </button>
    <button onclick="$.MultiLanguage('language.json', 'en')" id="lang-en" class="changeLanguage btn btn-primary">
      EN
    </button>
    <button onclick="$.MultiLanguage('language.json', 'nl')" id="lang-nl" class="changeLanguage btn btn-info">
      NL
    </button>
    <input type="hidden" value="FR" id="hiddenLanguage" />

    <br /><br />
    <div style="display: flex; align-items: center; margin-bottom: 5px">
      <button id="downloadPdf" class="btn btn-success" onclick="exportPDF()">
        Exporter le PDF
      </button>
      <button style="margin-left: 10px" id="dowloadJson" class="btn btn-secondary" onclick="exportToJsonFile()">
        Export JSON
      </button>
    </div>
    <div style="display: flex; align-items: center">
      <label style="margin-right: 5px" id="lbl-json" class="btn btn-warning">
        Sélectionner un fichier
        <input type="file" id="selectFiles" style="display: none" value="Import" class="form-control" />
      </label>
      <div id="divImport" class="hide-button">
        <button id="ImportJson" class="btn btn-warning">Import JSON</button>
      </div>
      <div id="file-name"></div>
    </div>

    <br /><br />

    <p>
      <img src="assets/img/info.png" style="width: 25px; float: left; margin-right: 10px" alt="" />Après avoir terminer
      la saisie de données, il suffit de choisir l'agence
      en question.
    </p>
    <p><strong>AGENCE</strong></p>
    <select class="company">
      <option value="byTheWay" selected="">By the Way</option>
      <option value="fiveBricks">5 Bricks</option>
      <option value="royalManor">Royal Manor</option>
      <option value="notajette">Notajette</option>
      <option value="engelAndVolkers">Engel &amp; Völkers</option>
      <option value="immoAndCo">Immo & Co</option>
      <option value="alterEgo">Alter Ego</option>
      <option value="soInvest">So Invest</option>
    </select>
    <input type="hidden" value="#EFB045" class="color-first-color" />
    <br /><br />
    <div id="SDC">
      <div style="padding: 9px"></div>
      <h3><strong class="synthese-charges">SYNTHÈSE DES CHARGES</strong></h3>
      <div id="mensuelle-block"></div>
      <!-- BLOCK CAMEMBERT -->
      <div id="camembert-block"></div>
      <div style="display: flex; align-items: center">
        <div id="piechart"></div>
        <div id="legend" style="display: flex; flex-direction: column"></div>
      </div>
    </div>
  </div>
</div>
<p>&nbsp;</p>
<!-- <button id="download-page-as-image">Valider</button> -->
<p>&nbsp;</p>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.9/summernote.js"></script>

<script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.0.0-rc.7/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-html2canvas@latest/dist/jspdf-html2canvas.min.js"></script>
<!-- EXPORT JSON -->
<script>
  var JSONobj = {
    AGENCE: "",
    LANG: "FR",
    TITLE: "",
    CHARGE: [],
    CE_TABLEAU: "",
    MOYENNE_MENSUELLE: "",
    QUOTITE: "",
    NOM_ACP: "",
    CAMEMBERT: [],
  };
  function exportToJsonFile() {
    let dataStr = JSON.stringify(JSONobj);
    let dataUri =
      "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);

    let exportFileDefaultName =
      "Backup Synthèse des charges - " + $('#title').val() + " [" + $("#hiddenLanguage").val() + "].json";

    let linkElement = document.createElement("a");
    linkElement.setAttribute("href", dataUri);
    linkElement.setAttribute("download", exportFileDefaultName);
    linkElement.click();
  }
</script>
<!-- IMPORT JSON -->
<script>
  $("#selectFiles").change(() => {
    var file = document.getElementById("selectFiles").files;
    if (file.length > 0) {
      $("#divImport").removeClass("hide-button");
      $("#file-name").text(file[0].name);
    } else {
      $("#divImport").addClass("hide-button");
      $("#file-name").text("");
    }
  });
  document.getElementById("ImportJson").onclick = function () {
    var files = document.getElementById("selectFiles").files;
    if (files.length <= 0) {
      return false;
    }
    var fr = new FileReader();
    fr.onload = function (e) {
      var result = JSON.parse(e.target.result);
      var formatted = JSON.stringify(result, null, 2);
      JSONobj = result;
      CreateTitleBlockWithJSON(JSONobj.TITLE);
      CreateLanguageBlockWithJSON(JSONobj.LANG);
      $(".company").val(String(JSONobj.AGENCE)).change();
      CreateBlockChargeWithJSON(JSONobj.CHARGE);
      CreateBlockCamambertWithJSON(JSONobj.CAMEMBERT);
      CreateBlockNOM_ACPWithJSON(JSONobj.NOM_ACP);
    };
    fr.readAsText(files.item(0));
  };
</script>

<!-- EXPORT TO PDF  -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
  integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script type="text/javascript">

  /* REAL TIME KEYUP ADDRESS AND DESCIPTION */
  $('.realTime').keyup(function () {
    var getID = $(this).attr('id');
    $('.' + getID).text($(this).val());
    if (getID == "title") {
      JSONobj.TITLE = $(this).val();
    }
  });



  const exportPDF = () => {


    var element = document.getElementById('SDC');
    var opt = {
      margin: [10, 10, 10, 13],
      filename: $('#title').val() + " - SDC" + "[" + $("#hiddenLanguage").val() + "].pdf",
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        dpi: 300,
        scale: 4,
        letterRendering: true,
        useCORS: true
      },
      jsPDF: { format: 'a4' }
    };

    // New Promise-based usage:
    html2pdf().set(opt).from(element).toPdf().get('pdf').toContainer().toCanvas().toPdf().save();

  };
</script>

<script>
  /*  $("#lbl-json").text("Sélectionner un fichier"); */
  var optionsDatepicker = {
    closeText: "Fermer",
    prevText: "Précédent",
    nextText: "Suivant",
    currentText: "Aujourd'hui",
    monthNames: [
      "Janvier",
      "Février",
      "Mars",
      "Avril",
      "Mai",
      "Juin",
      "Juillet",
      "Août",
      "Septembre",
      "Octobre",
      "Novembre",
      "Décembre",
    ],
    monthNamesShort: [
      "Janv.",
      "Févr.",
      "Mars",
      "Avril",
      "Mai",
      "Juin",
      "Juil.",
      "Août",
      "Sept.",
      "Oct.",
      "Nov.",
      "Déc.",
    ],
    dayNames: [
      "Dimanche",
      "Lundi",
      "Mardi",
      "Mercredi",
      "Jeudi",
      "Vendredi",
      "Samedi",
    ],
    dayNamesShort: ["Dim.", "Lun.", "Mar.", "Mer.", "Jeu.", "Ven.", "Sam."],
    dayNamesMin: ["D", "L", "M", "M", "J", "V", "S"],
    weekHeader: "Sem.",
    dateFormat: "dd/mm/yy",
  };

  /**
   * ################
   * CHANGE COMPANY
   * ################
   */
  var $array = [
    {
      name: "byTheWay",
      color: {
        val1: "#EFB045", // background-ag
        val2: "#EFB045", // change-style-li
        val3: "#EFB045", // title-mensuelle
        val4: "#FFDFA8", // content-mensuelle
        val5: "#EFB045", // quotites-background
        val6: "#EFB045", // annee-top-background
        val7: "#FFDFA8", // annee-bottom-background
      },
    },
    {
      name: "fiveBricks",
      color: {
        val1: "#78AA5E", // background-ag
        val2: "#78AA5E", // change-style-li
        val3: "#78AA5E", // title-mensuelle
        val4: "#BADBA8", // content-mensuelle
        val5: "#78AA5E", // quotites-background
        val6: "#78AA5E", // annee-top-background
        val7: "#BADBA8", // annee-bottom-background
      },
    },
    {
      name: "royalManor",
      color: {
        val1: "#EFD277", // background-ag
        val2: "#EFD277", // change-style-li
        val3: "#EFD277", // title-mensuelle
        val4: "#F7E6B3", // content-mensuelle
        val5: "#EFD277", // quotites-background
        val6: "#EFD277", // annee-top-background
        val7: "#F7E6B3", // annee-bottom-background
      },
    },
    {
      name: "notajette",
      color: {
        val1: "#3D505E", // background-ag
        val2: "#3D505E", // change-style-li
        val3: "#3D505E", // title-mensuelle
        val4: "#7F99AD", // content-mensuelle
        val5: "#3D505E", // quotites-background
        val6: "#3D505E", // annee-top-background
        val7: "#7F99AD", // annee-bottom-background
      },
    },
    {
      name: "engelAndVolkers",
      color: {
        val1: "#E93323", // background-ag
        val2: "#E93323", // change-style-li
        val3: "#E93323", // title-mensuelle
        val4: "#F4887F", // content-mensuelle
        val5: "#E93323", // quotites-background
        val6: "#E93323", // annee-top-background
        val7: "#F4887F", // annee-bottom-background
      },
    },
    {
      name: "immoAndCo",
      color: {
        val1: "#ED6F69", // background-ag
        val2: "#ED6F69", // change-style-li
        val3: "#ED6F69", // title-mensuelle
        val4: "#FFC7C2", // content-mensuelle
        val5: "#ED6F69", // quotites-background
        val6: "#ED6F69", // annee-top-background
        val7: "#FFC7C2", // annee-bottom-background
      },
    },
    {
      name: "alterEgo",
      color: {
        val1: "#008570", // background-ag
        val2: "#008570", // change-style-li
        val3: "#008570", // title-mensuelle
        val4: "#63BCAE", // content-mensuelle
        val5: "#008570", // quotites-background
        val6: "#008570", // annee-top-background
        val7: "#63BCAE", // annee-bottom-background
      },
    },
    {
      name: "soInvest",
      color: {
        val1: "#F0C294", // background-ag
        val2: "#F0C294", // change-style-li
        val3: "#F0C294", // title-mensuelle
        val4: "#FEEAD6", // content-mensuelle
        val5: "#F0C294", // quotites-background
        val6: "#F0C294", // annee-top-background
        val7: "#FEEAD6", // annee-bottom-background
      },
    },
  ];

  function changeColor($val) {
    $array.forEach((element, index, array) => {
      if ($val === element.name) {
        JSONobj.AGENCE = $val;
        $(".background-ag").css("background", element.color.val1);
        $(".change-style-li").html(
          "<style>.synthese-des-charges ul li::before {color: " +
          element.color.val2 +
          ";}</style>"
        );
        $(".title-mensuelle").css("background", element.color.val3);
        $(".content-mensuelle").css("background", element.color.val4);
        if (element.color.val5 == '#3D505E') {
          $("#quotites-background").css("color", '#fff');
        }
        $("#quotites-background").css("background", element.color.val5);
        $(".annee-top-background").css("background", element.color.val6);
        $(".annee-bottom-background").css("background", element.color.val7);
        $(".color-first-color").val(element.color.val1);
      }
    });
  }

  $(".company").change(function () {
    changeColor($(this).val());
    JSONobj.AGENCE = $(this).val();
    localStorage.setItem("AGENCE", JSONobj.AGENCE);
    $(".validate-camembert").click();
  });

  const CreateLanguageBlockWithJSON = (LANG) => {
    if (!!LANG) {
      $("#hiddenLanguage").val(`${LANG}`);
      $.MultiLanguage("language.json", `${LANG}`.toLowerCase());
      return;
    }
  };
  const CreateTitleBlockWithJSON = (TITLE) => {
    if (!!TITLE) {
      $("#title").val(`${TITLE}`);
      return;
    }
  };

  /**
   * ################
   * SCRIPT AG
   * ################
   */

  /* REPEAT BLOCK AG */
  function repeatBlock(el) {
    return `
              <select name="titleAG[]" style="width:37.5%;padding:11.2px;" class="latLong">
                  <option value="">Type d'AG</option>
                  <option ${el ? el.titleAG === "AG" && "selected" : ""
      } value="AG">AG</option>
                  <option ${el ? el.titleAG === "AGE" && "selected" : ""
      } value="AGE">AGE</option>
              </select>
              <input type="text" name="dateAG[]" value="${el ? el.dateAG : ""
      }" style="width: 54.4%;" class="latLong datepicker" placeholder="Date" />
              <br />
              <textarea placeholder="Description" class="realTime summernote localisation-address" id="description" name="descriptionAG[]">${el ? el.descriptionAG : ""
      }</textarea>
          `;
  }

  const CreateBlockAgWithJSON = (AG) => {
    if (AG[0] && !!AG) {
      /* THIS BLOCK IS FOR THE FIRST DIV (NOT FOR REPEATED BLOCK) */
      $(".repeat-block-ag").html(`
                  <select name="titleAG[]" style="width:37.5%;padding:11.2px;"  class="latLong">
                      <option value="">Type d'AG</option>
                      <option value="AG" ${AG[0].titleAG === "AG" && "selected"
        }>AG</option>
                      <option value="AGE" ${AG[0].titleAG === "AGE" && "selected"
        }>AGE</option>
                  </select>
                  <input type="text" name="dateAG[]" style="width: 54.4%;" class="latLong datepicker" placeholder="Date" value="${AG[0].dateAG
        }" />
                  <br />
                  <textarea placeholder="Description"  class="realTime summernote localisation-address " id="description" name="descriptionAG[]">${AG[0].descriptionAG
        }</textarea>
              `);

      /* CREATE AUTO LINES IF IMPORT FROM JSON */
      AG.slice(1).map((el) => {
        $(".content-ag-block").append(
          '<div class="margin-bottom-5 t' +
          el.id +
          '">' +
          repeatBlock(el) +
          '<span class="delete-it cursor-pointer">X</span></div>'
        );
        $(".summernote").summernote();
        $(".delete-it").click(function () {
          $(this).parent().remove();
          JSONobj.AG = JSONobj.AG.filter((el2) => el2.id !== el.id);
        });
        $(".datepicker").datepicker(optionsDatepicker);
      });

      /* RESET ALL DATAS => THE FUNCTION IS AT THE BOTTOM */
      $(".reset-ag").click();

      /* AUTO CLICK IF IMPORT FROM JSON AND PUT ALL DATAS IL SIDE BLOCK & MAPS => THE FUNCTION IS AT THE BOTTOM */
      $(".validate-ag").click();

      return;
    }
  };

  /* ON LOAD PAGE */
  $(".repeat-block-ag").html(repeatBlock((el = null)));

  /* ADD NEW AG */
  $(".add-new-ag").click(function () {
    var rand = Math.random().toString(36).slice(2);
    $(".content-ag-block").append(
      '<div class="margin-bottom-5 t' +
      rand +
      '">' +
      repeatBlock((el = null)) +
      '<span class="delete-it cursor-pointer">X</span></div>'
    );
    /* INITIALIZE TEXTAREA BLOCK */
    $(".summernote").summernote();
    /* DELETE AG LINE */
    $(".delete-it").click(function () {
      $(this).parent().remove();
    });
    $(".datepicker").datepicker(optionsDatepicker);
  });

  /* VALIDATE AG */
  $(".validate-ag").click(function () {
    $('#ag-block').html('');
    var i = 0;
    var titleArray = [];
    $("select[name='titleAG[]'] option:selected").each(function () {
      titleArray.push($(this).val());
    });
    var dateArray = [];
    $("input[name='dateAG[]']").map(function () {
      dateArray.push($(this).val());
    });
    var descriptionArray = [];
    $("textarea[name='descriptionAG[]']").map(function () {
      descriptionArray.push($(this).val());
    });
    $("select[name='titleAG[]']").map(function () {
      var content =
        `
                  <p class="background-ag" style="background:#fab240;padding:8px 12px;color:#fff;margin-bottom:15px;"><span><strong>` +
        titleArray[i] +
        ` ` +
        dateArray[i] +
        `</strong></span></p>
                  <p>` +
        descriptionArray[i] +
        `</p>
                  <p style="line-height:0;">&nbsp;</p>
              `;

      JSONobj.AG = [
        ...JSONobj.AG.filter((el) => el.id !== i),
        {
          id: i,
          titleAG: titleArray[i],
          dateAG: dateArray[i],
          descriptionAG: descriptionArray[i],
        },
      ];

      i++;
      $("#ag-block").append(content);
    });

    changeColor($(".company").val());
  });

  /* RESET AG */
  $(".reset-ag").click(function () {
    $("#ag-block").html("");
  });

  /**
   * ################
   * SCRIPT MENSUELLE
   * ################
   */

  const CreateBlockChargeWithJSON = (charge) => {
    if (!!charge) {
      if (charge[0]) {
        if (Array.isArray(charge[0].T) === true) {
          $(".type-mensuelle").val("Trimestriel");
          $("#block-type-charge").html(``);
          var o = 1;
          charge.map((el) => {
            $("#block-type-charge").append(
              `
                                  <input type="text" name="annee-${el.id}" class="latLong margin-top-10" placeholder="Année ` +
              o +
              `" value=${el.Année} />
                              <br />
                          `
            );
            el.T.map((el2) => {
              $("#block-type-charge").append(
                `
                                  <input type="text" name="valeur-annee-${el.id}[]" class="latLong margin-top-10" placeholder="T` +
                o +
                `" value=${el2} />
                                  <br />
                              `
              );
            });
            o++;
          });
          for (i = 1; i <= 4 - charge.length; i++) {
            $("#block-type-charge").append(`
                              <input type="text" name="annee-${o}" class="latLong margin-top-10" placeholder="Année ${o}"  />
                              <br />
                          `);
            for (j = 1; j < 5; j++) {
              $("#block-type-charge").append(
                `
                                  <input type="text" name="valeur-annee-${o}[]" class="latLong margin-top-10" placeholder="T` +
                j +
                `"  />
                                  <br />
                              `
              );
            }
            o++;
          }
        } else {
          $(".type-mensuelle").val("Annuel");
          $("#block-type-charge").html(``);
          var o = 1;
          charge.map((el) => {
            $("#block-type-charge").append(
              `
                              <input type="text" name="annee-${el.id}" class="latLong margin-top-10" placeholder="Année ` +
              o +
              `" value=${el.Année} />
                              <br />
                              <input type="text" name="valeur-annee-${el.id}" class="latLong margin-top-10" placeholder="Total Année ` +
              o +
              `" value=${el.T} />
                              <br /><br />
                          `
            );
            o++;
          });
          for (i = 1; i <= 4 - charge.length; i++) {
            $("#block-type-charge").append(`
                              <input type="text" name="annee-${o}" class="latLong margin-top-10" placeholder="Année ${o}"  />
                              <br />
                              <input type="text" name="valeur-annee-${o}" class="latLong margin-top-10" placeholder="Total Année ${o}"  />
                              <br /><br />
                          `);
            o++;
          }
        }
        $("#descriptionCharge").val(JSONobj.CE_TABLEAU);
        $("#valeurMensuelle").val(JSONobj.MOYENNE_MENSUELLE);
        $("#valeurQuotites").val(JSONobj.QUOTITE);
      }

      /* AUTO CLICK IF IMPORT FROM JSON AND PUT ALL DATAS IL SIDE BLOCK & MAPS => THE FUNCTION IS AT THE BOTTOM */

      setTimeout(function () { $(".validate-mensuelle").click(); }, 1000);
      $.MultiLanguage("language.json");
    }
  };

  $(".type-mensuelle").change(function () {
    if ($(this).val() == "Trimestriel") {
      $("#block-type-charge").html(`
                  <input type="text" name="annee-1" class="latLong margin-top-10" placeholder="Année 1" />
                  <br />
                  <input type="text" name="valeur-annee-1[]" class="latLong margin-top-10" placeholder="T1" />
                  <br />
                  <input type="text" name="valeur-annee-1[]" class="latLong margin-top-10" placeholder="T2" />
                  <br />
                  <input type="text" name="valeur-annee-1[]" class="latLong margin-top-10" placeholder="T3" />
                  <br />
                  <input type="text" name="valeur-annee-1[]" class="latLong margin-top-10" placeholder="T4" />
                  <br /><br />
                  <input type="text" name="annee-2" class="latLong margin-top-10" placeholder="Année 2" />
                  <br />
                  <input type="text" name="valeur-annee-2[]" class="latLong margin-top-10" placeholder="T1" />
                  <br />
                  <input type="text" name="valeur-annee-2[]" class="latLong margin-top-10" placeholder="T2" />
                  <br />
                  <input type="text" name="valeur-annee-2[]" class="latLong margin-top-10" placeholder="T3" />
                  <br />
                  <input type="text" name="valeur-annee-2[]" class="latLong margin-top-10" placeholder="T4" />
                  <br /><br />
                  <input type="text" name="annee-3" class="latLong margin-top-10" placeholder="Année 3" />
                  <br />
                  <input type="text" name="valeur-annee-3[]" class="latLong margin-top-10" placeholder="T1" />
                  <br />
                  <input type="text" name="valeur-annee-3[]" class="latLong margin-top-10" placeholder="T2" />
                  <br />
                  <input type="text" name="valeur-annee-3[]" class="latLong margin-top-10" placeholder="T3" />
                  <br />
                  <input type="text" name="valeur-annee-3[]" class="latLong margin-top-10" placeholder="T4" />
                  <br /><br />
                  <input type="text" name="annee-4" class="latLong margin-top-10" placeholder="Année 4" />
                  <br />
                  <input type="text" name="valeur-annee-4[]" class="latLong margin-top-10" placeholder="T1" />
                  <br />
                  <input type="text" name="valeur-annee-4[]" class="latLong margin-top-10" placeholder="T2" />
                  <br />
                  <input type="text" name="valeur-annee-4[]" class="latLong margin-top-10" placeholder="T3" />
                  <br />
                  <input type="text" name="valeur-annee-4[]" class="latLong margin-top-10" placeholder="T4" />
              `);
    } else if ($(this).val() == "Annuel") {
      $("#block-type-charge").html(`
                  <input type="text" name="annee-1" class="latLong margin-top-10" placeholder="Année 1" />
                  <br />
                  <input type="text" name="valeur-annee-1" class="latLong margin-top-10" placeholder="Total Année 1" />
                  <br /><br />
                  <input type="text" name="annee-2" class="latLong margin-top-10" placeholder="Année 2" />
                  <br />
                  <input type="text" name="valeur-annee-2" class="latLong margin-top-10" placeholder="Total Année 2" />
                  <br /><br />
                  <input type="text" name="annee-3" class="latLong margin-top-10" placeholder="Année 3" />
                  <br />
                  <input type="text" name="valeur-annee-3" class="latLong margin-top-10" placeholder="Total Année 3" />
                  <br /><br />
                  <input type="text" name="annee-4" class="latLong margin-top-10" placeholder="Année 4" />
                  <br />
                  <input type="text" name="valeur-annee-4" class="latLong margin-top-10" placeholder="Total Année 4" />
              `);
    } else {
      $("#block-type-charge").html(``);
    }
  });

  /* VALIDATE MENSUELLE */
  var years = [];
  $(".validate-mensuelle").click(function () {
    var descriptionCharge = $("#descriptionCharge").val();
    var valeurMensuelle = $("#valeurMensuelle").val();
    var valeurQuotites = $("#valeurQuotites").val();

    var contentArray = '<table class="table-mensuelle">';

    for (i = 1; i <= 4; i++) {
      var aux = [];

      if (
        $("input[name='annee-" + i + "']").val() != "" &&
        $(".type-mensuelle").val() == "Trimestriel"
      ) {
        /* TO GET AFTER THE FIRST AND LAST YEAR */
        years.push($("input[name='annee-" + i + "']").val());
        contentArray +=
          `
                      <tr>
                          <td colspan="4" class="center-padding annee-top-background color-white"><strong>` +
          $("input[name='annee-" + i + "']").val() +
          `</strong></td>
                      </tr>
                      <tr class="annee-bottom-background">
                          <td class="center-padding">T1</td>
                          <td class="center-padding">T2</td>
                          <td class="center-padding">T3</td>
                          <td class="center-padding">T4</td>
                      </tr>
                      <tr class="bottom">`;
        $("input[name='valeur-annee-" + i + "[]']").map(function () {
          aux = [...aux, $(this).val()];
          contentArray +=
            `<td class="center-padding">` + `${$(this).val() ? $(this).val() + '€' : '-'}` + ` </td>`;
        });
        contentArray += `</tr>`;
        JSONobj.CHARGE = [
          ...JSONobj.CHARGE.filter((el) => el.id !== i),
          {
            id: i,
            Année: $("input[name='annee-" + i + "']").val(),
            T: [...aux],
          },
        ];
      } else if (
        $("input[name='annee-" + i + "']").val() != "" &&
        $(".type-mensuelle").val() == "Annuel"
      ) {
        /* TO GET AFTER THE FIRST AND LAST YEAR */
        years.push($("input[name='annee-" + i + "']").val());
        contentArray +=
          `
                  <tr>
                      <td class="center-padding annee-top-background color-white"><strong>` +
          $("input[name='annee-" + i + "']").val() +
          `</strong></td>
                  </tr>
                  <tr class="annee-bottom-background">
                      <td class="center-padding total-table"></td>
                  </tr>
                  <tr class="bottom">
                      <td class="center-padding">` +
          `${$("input[name='valeur-annee-" + i + "']").val() ? $("input[name='valeur-annee-" + i + "']").val() + '€' : '-'} ` +
          ` </td>
                  </tr>`;
        JSONobj.CHARGE = [
          ...JSONobj.CHARGE.filter((el) => el.id !== i),
          {
            id: i,
            Année: $("input[name='annee-" + i + "']").val(),
            T: $("input[name='valeur-annee-" + i + "']").val(),
          },
        ];
      }
    }

    contentArray += `</table>`;

    var content =
      `
              <p class="description-charge"><span class="comprend"></span>` +
      descriptionCharge +
      `</p>
              <div class="row">
                  <div class="col-md-8">
                      ` +
      contentArray +
      `
                  </div>
                  <div class="col-md-4">
                      <div class="title-mensuelle"><strong id="moyenne-mensuelle" class="font-size-15"></strong></div>
                      <div class="content-mensuelle font-size-15">` +
      valeurMensuelle +
      ` €</div>`;
    if (valeurQuotites) {
      content += `<div style="margin-top:10px;" class="quotite font-size-15" id="quotites-background">`;

      if (localStorage.getItem("AGENCE") == 'notajette' || JSONobj.AGENCE == 'notajette') {
        content += `<span style="color:#fff !important;">`;
      }

      content += `
            <span id="quotites"></span> : ` +
        valeurQuotites;

      if (localStorage.getItem("AGENCE") == 'notajette' || JSONobj.AGENCE == 'notajette') {
        content += `</span>`;
      }

      content += `</div>`;
    }

    content += ` </div>
                  <p class="col-md-12">&nbsp;</p>
              </div>
          `;

    JSONobj.CE_TABLEAU = descriptionCharge;
    JSONobj.QUOTITE = valeurQuotites;
    JSONobj.MOYENNE_MENSUELLE = $("#valeurMensuelle").val();

    $("#mensuelle-block").html(content);

    changeColor($(".company").val());
    $.MultiLanguage("language.json");
  });

  /**
   * ################
   * SCRIPT CAMEMBERT
   * ################
   */


  const CreateBlockNOM_ACPWithJSON = (NOM_ACP) => {
    if (!!NOM_ACP) {
      $("input[name='descriptionCamembert']").val(`${NOM_ACP}`);
      JSONobj.NOM_ACP = `${NOM_ACP}`;
      return;
    }
  };

  const CreateBlockCamambertWithJSON = (cam) => {
    if (cam[0] && !!cam) {
      console.log(cam[0].titleText, ' : cam[0].titleText')
      $(".content-camembert-block").html(`
          <input type="text"name="titleCamembertText[]" style="width: 25%;margin-bottom: 10px;padding: 8px 12px;" class="latLong" placeholder="Titre de charge" value='${cam[0].titleText ? cam[0].titleText : ''}'/>
          &nbsp; OU &nbsp; 
          <select name="titleCamembert[]" style="padding:10px;">
            <option>Sélectionner</option>
            <option ${cam[0].title == 'val-1' ? 'selected' : ''} value="val-1" class="val-1"></option>
            <option ${cam[0].title == 'val-2' ? 'selected' : ''} value="val-2" class="val-2"></option>
            <option ${cam[0].title == 'val-3' ? 'selected' : ''} value="val-3" class="val-3"></option>
            <option ${cam[0].title == 'val-4' ? 'selected' : ''} value="val-4" class="val-4"></option>
            <option ${cam[0].title == 'val-5' ? 'selected' : ''} value="val-5" class="val-5"></option>
            <option ${cam[0].title == 'val-6' ? 'selected' : ''} value="val-6" class="val-6"></option>
            <option ${cam[0].title == 'val-7' ? 'selected' : ''} value="val-7" class="val-7"></option>
            <option ${cam[0].title == 'val-8' ? 'selected' : ''} value="val-8" class="val-8"></option>
            <option ${cam[0].title == 'val-9' ? 'selected' : ''} value="val-9" class="val-9"></option>
            <option ${cam[0].title == 'val-10' ? 'selected' : ''} value="val-10" class="val-10"></option>
            <option ${cam[0].title == 'val-11' ? 'selected' : ''} value="val-11" class="val-11"></option>
            <option ${cam[0].title == 'val-12' ? 'selected' : ''} value="val-12" class="val-12"></option>
            <option ${cam[0].title == 'val-13' ? 'selected' : ''} value="val-13" class="val-13"></option>
            <option ${cam[0].title == 'val-14' ? 'selected' : ''} value="val-14" class="val-14"></option>
          </select>
          <input type="number"name="percentCamembert[]" style="width: 25%;margin-bottom: 10px;padding: 8px 12px;" class="latLong" placeholder="Pourcentage" value='${cam[0].percent}'/>
          `);
      cam.slice(1).map((el) => {
        if (el != '') {
          $(".content-camembert-block").append(
            '<div class="margin-bottom-5">' +
            repeatBlockCamembert(el) +
            '<span class="delete-it delete-it-2 cursor-pointer" style="margin-left: 13%;">X</span></div>'
          );
          /* DELETE CAMEMBERT LINE */
          $(".delete-it").click(function () {
            $(this).parent().remove();
            JSONobj.CAMEMBERT = JSONobj.CAMEMBERT.filter(
              (el2) => el2.id !== el.id
            );
          });
        }
      });

      /* RESET ALL DATAS => THE FUNCTION IS AT THE BOTTOM */
      setTimeout(function () { resetCamembert(); }, 1000);

      /* AUTO CLICK IF IMPORT FROM JSON AND PUT ALL DATAS IL SIDE BLOCK & MAPS => THE FUNCTION IS AT THE BOTTOM */
      setTimeout(function () { validateCamembert(); }, 1400);
    }
  };

  /* VALIDATE MENSUELLE */
  $(".validate-camembert").click(function () {
    setTimeout(function () { validateCamembert(); }, 1000);
  });

  function validateCamembert() {
    var firstYear = years[0];
    var lastYear = years[years.length - 1];
    if (firstYear && lastYear) {
      var d = ` - ` + firstYear + `/` + lastYear;
    } else {
      var d = "";
    }

    function hex(c) {
      var s = "0123456789abcdef";
      var i = parseInt(c);
      if (i == 0 || isNaN(c))
        return "00";
      i = Math.round(Math.min(Math.max(0, i), 255));
      return s.charAt((i - i % 16) / 16) + s.charAt(i % 16);
    }

    /* Convert an RGB triplet to a hex string */
    function convertToHex(rgb) {
      return hex(rgb[0]) + hex(rgb[1]) + hex(rgb[2]);
    }

    /* Remove '#' in color hex string */
    function trim(s) { return (s.charAt(0) == '#') ? s.substring(1, 7) : s }

    /* Convert a hex string to an RGB triplet */
    function convertToRGB(hex) {
      var color = [];
      color[0] = parseInt((trim(hex)).substring(0, 2), 16);
      color[1] = parseInt((trim(hex)).substring(2, 4), 16);
      color[2] = parseInt((trim(hex)).substring(4, 6), 16);
      return color;
    }

    function generateColor(colorStart, colorEnd, colorCount) {

      // The beginning of your gradient
      var start = convertToRGB(colorStart);

      // The end of your gradient
      var end = convertToRGB(colorEnd);

      // The number of colors to compute
      var len = colorCount;

      //Alpha blending amount
      var alpha = 0.0;

      var saida = [];

      for (i = 0; i < len; i++) {
        var c = [];
        alpha += (1.0 / len);

        c[0] = start[0] * alpha + (1 - alpha) * end[0];
        c[1] = start[1] * alpha + (1 - alpha) * end[1];
        c[2] = start[2] * alpha + (1 - alpha) * end[2];

        saida.push(convertToHex(c));

      }

      return saida;

    }


    var tmp = generateColor('#000000', $('.color-first-color').val(), 10);
    var colorCamembert = [];
    // for (cor in tmp) {
    //     colorCamembert.push('#'+tmp[cor]);
    // };
    colorCamembert = ["#E74C3C", "#E67E22", "#FFCD02", "#1ABC9C", "#8EB021", "#2980B9", "#D45C9E", "#5B48A2", "#008570", "#ED6F69", "#EFD277"]

    var descriptionCamembert = $("input[name='descriptionCamembert']").val();
    var content =
      `
              <p>&nbsp;</p>
              <h5 class="center-padding"><strong><span class="repartirion"></span> - ACP ` +
      descriptionCamembert +
      d +
      `</strong></h5>
          `;
    $("#camembert-block").html(content);
    $.MultiLanguage("language.json");

    var titleCamembert = [];
    $("select[name='titleCamembert[]'] option:selected").map(function () {
      titleCamembert.push($(this).val());
    });

    var titleCamembertText = [];
    $("input[name='titleCamembertText[]']").map(function () {
      titleCamembertText.push($(this).val());
    });

    var percentCamembert = [];
    $("input[name='percentCamembert[]']").map(function () {
      percentCamembert.push($(this).val());
    });

    // $("input[name='colorCamembert[]']").map(function () {
    //   colorCamembert.push($(this).val());
    // });

    var contentChart = `<script>
              function drawChart() {
                  var data = google.visualization.arrayToDataTable([
                      ['', ''],`;

    var i = 0;
    $("select[name='titleCamembert[]'] option:selected").map(function () {
      if ($(this).html() == 'Sélectionner') {
        contentChart += `["` + titleCamembertText[i] + `", ` + percentCamembert[i] + `],`;
      } else {
        contentChart += `["` + $(this).html() + `", ` + percentCamembert[i] + `],`;
      }
      i++;
    });

    contentChart += `]);
                  var options = {
                      'title': '',
                      'width': 500,
                      'height': 450,
                      'pieHole': 0.6,
                      'pieSliceText': 'percentage',
                      'pieSliceTextStyle': {
                          'color': 'white',
                          'fontSize': 14
                      },
                      'legend': 'none',
                      'sliceVisibilityThreshold': 0,
                      'chartArea': {top: 0, width: "90%", height: "80%"},
                      'colors': [`;
    var j = 0;
    $("select[name='titleCamembert[]'] option:selected").map(function () {
      contentChart += `"` + colorCamembert[j] + `",`;
      j++;
    });

    contentChart += `]
                  };
                  var chart = new google.visualization.PieChart(document.getElementById('piechart'));
                  chart.draw(data, options);
              }
              google.charts.load('current', { 'packages': ['corechart'] });
              google.charts.setOnLoadCallback(drawChart);
              <\/script>`;
    $("#piechart").html(contentChart);
    var legend = "";
    var k = 0;
    var mm = 1;
    $("select[name='titleCamembert[]'] option:selected").map(function () {

      var titleFinal = "";
      if ($(this).html() == "Sélectionner") {
        titleFinal = titleCamembertText[k];
      } else {
        titleFinal = $(this).html();
      }

      legend +=
        `<div style="display: flex;align-items: center;margin:5px"><div style="width:15px;display: inline-block; margin-right:5px;height:15px;border-radius:100%;background:` +
        colorCamembert[k] +
        `"></div><span> ` +
        titleFinal +
        ` </span></div>`;
      if (titleCamembert[k] && percentCamembert[k]) {
        JSONobj.CAMEMBERT = [
          ...JSONobj.CAMEMBERT.filter((el) => el.title !== titleCamembert[k]),
          {
            id: mm,
            title: titleCamembert[k],
            titleText: titleCamembertText[k],
            color: colorCamembert[k],
            percent: percentCamembert[k],
          },
        ];
        k++;
        mm++;
      }


    });


    if (JSONobj.NOM_ACP) {
      if (JSONobj.NOM_ACP != $("input[name='descriptionCamembert']").val() && $("input[name='descriptionCamembert']").val() != '') {
        JSONobj.NOM_ACP = $("input[name='descriptionCamembert']").val();
      } else {
        $("input[name='descriptionCamembert']").val(JSONobj.NOM_ACP);
      }
    } else {
      JSONobj.NOM_ACP = $("input[name='descriptionCamembert']").val();
      // lastYear !== undefined && firstYear !== undefined
      //   ? $("input[name='descriptionCamembert']").val() +
      //   " - " +
      //   lastYear +
      //   "/" +
      //   firstYear
      //   : $("input[name='descriptionCamembert']").val();
    }

    $("#legend").html(legend);

    changeColor($(".company").val());
  };

  /* REPEAT BLOCK FOR CAMEMBERT */
  function repeatBlockCamembert(el) {
    // <input type="text" name="titleCamembert[]" value="${el ? el.title : ""
    //   }" style="width: 54.4%;" class="latLong" placeholder="Titre de charge" />
    return `
          <input type="text"name="titleCamembertText[]" style="width: 25%;margin-bottom: 10px;padding: 8px 12px;" class="latLong" placeholder="Titre de charge" value='${el && el.title ? el.titleText : ''}'/>
          &nbsp; OU &nbsp;
          <select name="titleCamembert[]" style="padding:10px;">
            <option>Sélectionner</option>
            <option ${el && el.title == 'val-1' ? 'selected' : ''} value="val-1" class="val-1"></option>
            <option ${el && el.title == 'val-2' ? 'selected' : ''} value="val-2" class="val-2"></option>
            <option ${el && el.title == 'val-3' ? 'selected' : ''} value="val-3" class="val-3"></option>
            <option ${el && el.title == 'val-4' ? 'selected' : ''} value="val-4" class="val-4"></option>
            <option ${el && el.title == 'val-5' ? 'selected' : ''} value="val-5" class="val-5"></option>
            <option ${el && el.title == 'val-6' ? 'selected' : ''} value="val-6" class="val-6"></option>
            <option ${el && el.title == 'val-7' ? 'selected' : ''} value="val-7" class="val-7"></option>
            <option ${el && el.title == 'val-8' ? 'selected' : ''} value="val-8" class="val-8"></option>
            <option ${el && el.title == 'val-9' ? 'selected' : ''} value="val-9" class="val-9"></option>
            <option ${el && el.title == 'val-10' ? 'selected' : ''} value="val-10" class="val-10"></option>
            <option ${el && el.title == 'val-11' ? 'selected' : ''} value="val-11" class="val-11"></option>
            <option ${el && el.title == 'val-12' ? 'selected' : ''} value="val-12" class="val-12"></option>
            <option ${el && el.title == 'val-13' ? 'selected' : ''} value="val-13" class="val-13"></option>
            <option ${el && el.title == 'val-14' ? 'selected' : ''} value="val-14" class="val-14"></option>
          </select>
          <input type="number" name="percentCamembert[]" value="${el ? el.percent : ""
      }" style="width: 25%;margin-bottom: 10px;padding: 8px 12px;" class="latLong" placeholder="Pourcentage" />`;
  }
  // function repeatBlockCamembert2(obj) {
  //   const color = $array.filter((el) => el.name === $(".company").val());
  //   if (obj.length > 0) {
  //     obj.map((el) => {
  //       return `
  //         <input type="text" name="titleCamembert[]" value="${
  //           el ? el.title : ""
  //         }" style="width: 54.4%;" class="latLong" placeholder="Titre de charge" />
  //         <input type="number" name="percentCamembert[]" value="${
  //           el ? el.percent : ""
  //         }" style="width: 25%;margin-bottom: 10px;padding: 8px 12px;" class="latLong" placeholder="pourcentage" />
  //         <input type="color" name="colorCamembert[]" value="${
  //           color[0].color.val1
  //         }" style="width: 11%;height: 41px;position: absolute;margin-left: 5px;" placeholder="Couleur de charge" />
  //         `;
  //     });
  //   }
  // }
  $(".content-camembert-block").html(repeatBlockCamembert((el = null)));

  /* ADD NEW CAMEMBERT */
  $(".add-new-camembert").click(function () {
    $(".content-camembert-block").append(
      '<div class="margin-bottom-5">' +
      repeatBlockCamembert((el = null)) +
      '<span class="delete-it delete-it-2 cursor-pointer" style="margin-left: 13%;">X</span></div>'
    );
    /* DELETE CAMEMBERT LINE */
    $(".delete-it").click(function () {
      $(this).parent().remove();
    });
    $.MultiLanguage("language.json");
  });

  /* RESET CAMEMBERT */
  $(".reset-camembert").click(function () {
    setTimeout(function () { resetCamembert(); }, 1000);
  });

  function resetCamembert() {
    $("#camembert-block").html("");
    $("#piechart").html("");
    $("#legend").html("");
  }


</script>

<script src="assets/js/jquery.MultiLanguage.min.js"></script>
<script>
  $(document).ready(function () {
    $.MultiLanguage("language.json");
    $(".summernote").summernote();
  });

  /* IF CHANGE LANGUAGE */
  $(".changeLanguage").click(function () {
    if ($(this).attr("id") == "lang-fr") {
      JSONobj.LANG = "FR";
      $("#hiddenLanguage").val("FR");
      setTimeout(function () { validateCamembert(); }, 1000);
    } else if ($(this).attr("id") == "lang-en") {
      JSONobj.LANG = "EN";
      $("#hiddenLanguage").val("EN");
      setTimeout(function () { validateCamembert(); }, 1000);
    } else if ($(this).attr("id") == "lang-nl") {
      JSONobj.LANG = "NL";
      $("#hiddenLanguage").val("NL");
      setTimeout(function () { validateCamembert(); }, 1000);
    }
  });
</script>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script>
  $(function () {
    $(".datepicker").datepicker(optionsDatepicker);
  });
</script>